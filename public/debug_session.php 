<?php
// public/debug_session_detailed.php
require_once __DIR__ . '/../boot.php';

use Blog\Security\Authorization;

// Start session if not already started
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// Set content type
header('Content-Type: text/plain; charset=utf-8');

echo "=== Session Debug (Detailed) ===\n\n";

echo "Session ID: " . session_id() . "\n";
echo "Session status: " . session_status() . " (2 = PHP_SESSION_ACTIVE)\n";
echo "Session name: " . session_name() . "\n";

echo "\nSession cookie parameters:\n";
$params = session_get_cookie_params();
echo "  Lifetime: " . $params['lifetime'] . " seconds\n";
echo "  Path: " . $params['path'] . "\n";
echo "  Domain: " . $params['domain'] . "\n";
echo "  Secure: " . ($params['secure'] ? 'true' : 'false') . "\n";
echo "  HttpOnly: " . ($params['httponly'] ? 'true' : 'false') . "\n";
echo "  SameSite: " . ($params['samesite'] ?? 'Not set') . "\n";

echo "\nCookies from browser:\n";
if (empty($_COOKIE)) {
    echo "  No cookies received\n";
} else {
    foreach ($_COOKIE as $name => $value) {
        echo "  $name = $value\n";
        if ($name === session_name()) {
            echo "    ^ This is the session cookie\n";
        }
    }
}

echo "\nSession data:\n";
if (empty($_SESSION)) {
    echo "  No session data\n";
} else {
    foreach ($_SESSION as $key => $value) {
        if (is_string($value)) {
            echo "  [$key] = '$value' (length: " . strlen($value) . ")\n";
        } else {
            echo "  [$key] = " . json_encode($value) . "\n";
        }
    }
}

echo "\nAuthorization checks:\n";
echo "isAuthenticated(): " . (Authorization::isAuthenticated() ? 'true' : 'false') . "\n";

$user = Authorization::getUser();
echo "getUser(): " . json_encode($user) . "\n";

if ($user) {
    echo "hasRole('ROLE_MARK'): " . (Authorization::hasRole('ROLE_MARK') ? 'true' : 'false') . "\n";
    echo "isMark(): " . (Authorization::isMark() ? 'true' : 'false') . "\n";
}

echo "\nHTTP Headers being sent:\n";
$headers = headers_list();
if (empty($headers)) {
    echo "  No headers being sent\n";
} else {
    foreach ($headers as $header) {
        echo "  $header\n";
    }
}

echo "\n=== End Debug ===\n";